# resources/jobs/feature_engineering.yml
resources:
  jobs:
    feature_engineering:
      name: ngm-feature-engineering
      
      tags:
        git_sha: ${var.git_sha}
        purpose: feature_engineering
      
      job_clusters:
        - job_cluster_key: feature_cluster
          new_cluster:
            spark_version: "13.3.x-scala2.12"
            node_type_id: "Standard_DS3_v2"
            num_workers: 4  # More workers for transformation
            spark_conf:
              # Delta optimizations
              "spark.databricks.delta.optimizeWrite.enabled": "true"
              "spark.databricks.delta.autoCompact.enabled": "true"
      
      tasks:
        - task_key: build_features
          job_cluster_key: feature_cluster
          spark_python_task:
            python_file: ../../src/pipelines/feature_engineering.py
            parameters:
              - churn
        
        - task_key: optimize_tables
          depends_on:
            - task_key: build_features
          job_cluster_key: feature_cluster
          spark_python_task:
            python_file: ../../src/pipelines/optimize_features.py
      
      schedule:
        quartz_cron_expression: "0 0 2 * * ?"  # Daily at 2 AM
        timezone_id: "Australia/Sydney"